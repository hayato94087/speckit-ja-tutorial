---
description: チェックリストの項目をレビューし、フェーズに応じてspec.md/plan.md/tasks.mdに反映します。
handoffs: 
  - label: speckit.plan
    agent: speckit.plan
    prompt: 仕様の計画を作成します。
  - label: speckit.implement
    agent: speckit.implement
    prompt: フェーズごとに実装を開始します
---

## ユーザー入力

```text
$ARGUMENTS
```

続行する前に、ユーザー入力を考慮する**必要があります**（空でない場合）。

## 概要

目標: `/speckit.checklist` で生成されたチェックリストを分析し、各項目を適切なファイル（spec.md / plan.md / tasks.md）に反映します。フェーズ（存在するファイル）に応じて反映先を判断します。

**重要な原則**: 
- チェックリストのすべての項目を追加するのではなく、重要な項目のみを厳選
- 反映先別にグループ化し、詳細付きで5個ずつバッチ表示して確認
- 反映先はフェーズと項目の性質に応じて判断

## 実行ステップ

1. **環境セットアップ**: リポジトリルートから `.specify/scripts/bash/check-prerequisites.sh --json --paths-only` を**1回**実行し、JSONをパース:
   - `FEATURE_DIR`
   - `FEATURE_SPEC`
   - JSONパースが失敗した場合、中止してユーザーに `/speckit.specify` を再実行するよう指示。
   - 引数に "I'm Groot" のようなシングルクォートがある場合、エスケープ構文を使用: 例 'I'\''m Groot'（または可能なら二重引用符: "I'm Groot"）。

2. **フェーズの自動検出**: 存在するファイルを確認して現在のフェーズを判定:
   
   | 存在するファイル | フェーズ | 反映可能先 |
   |-----------------|---------|-----------|
   | spec.md のみ | spec後 | spec.md |
   | spec.md + plan.md | plan後 | spec.md, plan.md |
   | spec.md + plan.md + tasks.md | tasks後 | spec.md, plan.md, tasks.md |

3. **チェックリストの検出と読み込み**:
   - `FEATURE_DIR/checklists/` ディレクトリ内のすべての `.md` ファイルをスキャン
   - `requirements.md` は除外（これは仕様品質の検証用で、反映対象ではない）
   - ユーザーが `$ARGUMENTS` で特定のチェックリストを指定した場合、そのファイルのみを対象とする
   - 対象チェックリストが存在しない場合、`/speckit.checklist` を先に実行するよう指示
   - 未レビュー項目（`[ ]`）のみを対象とする

4. **コンテキストの読み込み**:
   - `FEATURE_SPEC`（spec.md）を読み込み
   - `FEATURE_DIR/plan.md`（存在する場合）を読み込み
   - `FEATURE_DIR/tasks.md`（存在する場合）を読み込み
   - `.specify/memory/constitution.md`（存在する場合）を読み込み、プロジェクト方針を把握

5. **スタイルガイドを読み込み**: `.specify/README.md` を読み込んで用語集とスタイルガイドを把握。ファイル更新時に以下を遵守:
   - セクション見出しには規定の絵文字を使用する
   - 用語対応表に従って一貫した日本語表現を使用する
   - 英語維持する特殊文字列（マーカー、ステータス、ファイル名等）は変換しない

6. **チェックリスト項目の分析と分類**: 各チェックリスト項目を以下の基準で分類し、**4つのグループ**に振り分ける。**各項目に対して「推奨する反映内容」を必ず生成する**:

   **反映先の判断基準**:

   | 項目の種類 | 反映先 | 例 |
   |-----------|--------|-----|
   | 要件の欠落・曖昧さ | spec.md | 空状態の表示、エラーメッセージ、アクセシビリティ要件 |
   | 技術的方針・設計決定 | plan.md | アニメーションライブラリ選定、レイアウト方式 |
   | 実装詳細・具体値 | tasks.md | opacity値、gap値、具体的なCSS |
   | 憲章でカバー済み | なし | `[COVERED]` |
   | 対応不要 | なし | `[WONT_DO]` |

   **🔧 複数候補の生成ルール（必須）**:
   
   各チェックリスト項目に対して、重要度に応じた候補を生成する:

   1. **コンテキスト参照**: spec.md、constitution.md、既存の受入シナリオを参照し、プロジェクトの文脈を理解
   2. **ギャップ分析**: チェックリストの指摘内容と現在の仕様を比較し、欠落している情報を特定
   3. **複数候補の生成**: 重要度に応じた候補数で、差別化基準に従って候補を生成

   **📊 候補の差別化基準**:
   | 選択肢 | コンセプト | 実装コスト | 説明 |
   |--------|-----------|-----------|------|
   | A | MVP / シンプル | 低（数時間） | 最低限の機能。テキストのみ等 |
   | B | 標準 / バランス | 中（1日程度） | 一般的なアプリで期待されるUX |
   | C | リッチ / 高機能 | 高（数日） | 感動を与えるUX。アニメーション等 |
   | D | 対応しない | - | MVP外、または不要と判断 |

   **📋 候補数の適用ルール**:
   | 重要度マーカー | 候補数 | 理由 |
   |---------------|--------|------|
   | `[Gap]` / `[Critical]` | A, B, C, D | 仕様の欠落は慎重に検討が必要 |
   | `[Recommended]` | A, B, D | 選択肢を提示しつつ簡潔に |
   | `[Minor]` / `[Nice-to-have]` | A, D | 判断に迷う余地が少ない |

   **推奨理由の生成ルール**:
   - 各項目の推奨選択肢に対して、1〜2文で簡潔な理由を記述する
   - 理由には「なぜその選択肢が最適か」「他の選択肢を選ばない理由」を含める
   - プロジェクトの性質（個人用/業務用、MVP/本格開発等）を考慮する

   **品質基準**:
   | 基準 | 要件 | 例 |
   |------|------|----|
   | 簡潔さ | 1〜2文、50文字以内を目安 | ✅「F2キーで編集モードに遷移する」 |
   | 具体性 | 曖昧な表現を避け、具体的な値・動作を記述 | ✅「100文字に達した時点で入力を受け付けない」 |
   | テスト可能性 | 検証可能な形式で記述 | ✅「フォーカスは選択したフィルタボタンに留まる」 |
   | 一貫性 | 既存の仕様・憲章のトーンに合わせる | 既存の受入シナリオの形式を踏襲 |

   **生成できない場合のフォールバック**:
   - 判断に迷う場合: `[要検討] 具体的な仕様をユーザーに確認してください`
   - 情報不足の場合: `[情報不足] spec.mdに追加情報が必要です: <必要な情報>`

   **グループ分け**（この順序で表示）:
   1. 📄 **spec.md グループ** - 要件の欠落・曖昧さに関する項目
   2. 📐 **plan.md グループ** - 技術的方針・設計決定に関する項目
   3. 🔧 **tasks.md グループ** - 実装詳細・具体値に関する項目
   4. ⏭️ **対応不要候補グループ** - COVERED/WONT_DO候補の項目

   **spec.mdに反映すべき項目**:
   - ユーザー体験に直接影響する要件の欠落（ゼロ状態、エラー状態、ローディング状態等）
   - アクセシビリティの本質的要件
   - 曖昧な表現の明確化
   - 受入テストの作成に必要な明確化

   **plan.mdに反映すべき項目**:
   - 技術スタックの選定に関わる決定
   - アーキテクチャ・設計方針
   - ライブラリ・フレームワークの選択理由

   **tasks.mdに反映すべき項目**:
   - 具体的な実装値（色、サイズ、間隔等）
   - 実装タスクの追加・修正

7. **インタラクティブレビュー（グループ別・5個バッチ表示）**:

   **6.1 グループサマリーの表示**:
   最初に全グループの概要を表示し、ユーザーにどのグループから確認するか選択させる:
   ```
   ## チェックリストレビュー開始

   **対象**: checklists/ux.md（20項目の未レビュー項目）

   ### 反映先別サマリー
   | グループ | 項目数 |
   |----------|-------|
   | 📄 spec.md | 8 |
   | 📐 plan.md | 5 |
   | 🔧 tasks.md | 3 |
   | ⏭️ 対応不要候補 | 4 |

   **どのグループから確認しますか？**
   - `spec` - spec.mdグループから開始
   - `all` - 全グループを順番に確認
   - `skip tasks` - tasks.mdグループをスキップして開始
   ```

   **6.2 詳細付き5個バッチ表示（複数候補形式）**:
   各グループ内で、詳細情報付きで5個ずつ表示。**重要度に応じた候補数で選択肢を提示する**:
   ```
   ## 📄 spec.md への反映候補（1-5/8件）

   ---
   ### 1. CHK005 - ゼロ状態の表示要件 [Gap]

   **指摘**: タスク一覧が空の場合（ゼロ状態）の表示要件が定義されているか？

   **推奨:** B
   **理由:** ユーザーが次のアクションを取りやすいガイダンスが重要。Aは情報不足、Cは個人用アプリには過剰。

   | 選択肢 | 内容 |
   |--------|------|
   | A | タスクが0件の場合、「タスクがありません」テキストを中央に表示する |
   | B | タスクが0件の場合、「タスクがありません。上の入力欄から追加してください」メッセージと「＋ タスクを追加」ボタンを中央に表示する |
   | C | タスクが0件の場合、イラスト付きの空状態画面を表示し、「最初のタスクを作成」ボタンとサンプルタスク例を提示する |
   | D | 対応しない |

   ---
   ### 2. CHK011 - ローディング状態 [Gap]

   **指摘**: データ読み込み中の表示が定義されているか？

   **推奨:** B
   **理由:** 長時間のローディングでユーザーが不安にならないよう、段階的なフィードバックが有効。

   | 選択肢 | 内容 |
   |--------|------|
   | A | データ取得中は、タスク一覧エリアにスピナーを表示する |
   | B | データ取得中はスピナーを表示し、3秒以上かかる場合は「読み込み中...」テキストも表示する |
   | C | データ取得中はスケルトンUIを表示し、プログレスバーで進捗を示す |
   | D | 対応しない |

   ---
   ### 3. CHK014 - エラー状態の表示 [Critical]

   **指摘**: データ取得失敗時のエラー表示が定義されているか？

   **推奨:** B
   **理由:** エラーからの回復手段（再試行）を提供することで、ユーザーが行き詰まらない。Cはオフライン対応が必要で複雑。

   | 選択肢 | 内容 |
   |--------|------|
   | A | データ取得に失敗した場合、「エラーが発生しました」メッセージを表示する |
   | B | データ取得に失敗した場合、「データを読み込めませんでした」メッセージと「再試行」ボタンを表示する |
   | C | データ取得に失敗した場合、エラー種別に応じたメッセージと「再試行」「オフラインモードで続行」を提供する |
   | D | 対応しない |

   ---
   ### 4. CHK018 - 文字数制限の表示 [Recommended]

   **指摘**: タスク名の文字数制限に近づいた時の表示が定義されているか？

   **推奨:** A
   **理由:** シンプルなカウンター表示で十分。警告色は過剰な注意喚起になる可能性がある。

   | 選択肢 | 内容 |
   |--------|------|
   | A | タスク名が80文字を超えた場合、残り文字数をグレーテキストで表示する |
   | B | タスク名が80文字を超えた場合、残り文字数を表示し、100文字に達すると赤色で警告表示する |
   | D | 対応しない |

   ---
   ### 5. CHK022 - キーボードショートカット [Minor]

   **指摘**: キーボードショートカットの一覧が定義されているか？

   **推奨:** A
   **理由:** 基本的なキーボード操作はアクセシビリティの観点からも必要。

   | 選択肢 | 内容 |
   |--------|------|
   | A | Enterキーでタスク追加、Escapeキーで入力キャンセル、Delete/Backspaceキーで選択タスク削除を可能にする |
   | D | 対応しない |

   ---
   **回答方法**:
   | コマンド | 説明 |
   |----------|------|
   | `recommended` | 5件すべて推奨で反映 |
   | `1B, 2A, 3C, 4A, 5D` | 個別に選択 |
   | `next` | 次の5件へ |

   **自由入力**: 項目番号と内容を記述（例: `3: タスクが空の場合は灰色の背景を表示`）

   **推奨**: 1B, 2B, 3B, 4A, 5A

   **入力してください**:
   ```

   **6.3 グループ完了サマリー**:
   各グループの処理完了後にサマリーを表示:
   ```
   ## ✅ spec.md グループ完了（8件中 6件反映）

   | # | ID | 結果 |
   |---|------|------|
   | 1 | CHK005 | ✅ 反映 |
   | 2 | CHK011 | ✅ 反映 |
   | 3 | CHK014 | ⏭️ スキップ |
   | 4 | CHK018 | ✅ 反映 |
   | 5 | CHK022 | ✅ 反映 |
   | 6 | CHK025 | ✅ 反映 |
   | 7 | CHK028 | ⏭️ スキップ |
   | 8 | CHK031 | ✅ 反映 |

   ---
   **次**: 📐 plan.md（5件）→ `yes` / `skip` / `done`
   ```

   **動作ルール**:
   - バッチサイズは**5件**固定
   - グループ表示順序: spec.md → plan.md → tasks.md → 対応不要候補
   - ユーザーが "next" と言った場合、次の5件へ（未回答は保留）
   - ユーザーが "recommended" と言った場合、全項目を推奨オプションで反映

7. **ファイルへの反映（承認された項目のみ）**:
   - ユーザーが選択肢A/B/Cのいずれかを選択した項目のみを対象ファイルに反映
   - 選択肢Dを選択した項目は `[WONT_DO]` としてマーク
   
   **spec.mdへの反映ルール**:
   - `## Clarifications` セクションの `### Session YYYY-MM-DD` に追加ログを記録: `- [From CHK###] <追加内容の要約>`
   - 適切なセクションに要件を追加（新規セクション作成は最小限に）
   - 実装詳細（技術スタック、フレームワーク名等）は含めない
   - 要件は測定可能・テスト可能な形式で記述

   **plan.mdへの反映ルール**:
   - 適切なセクション（技術スタック、設計方針等）に追記
   - 技術的な決定とその理由を記載

   **tasks.mdへの反映ルール**:
   - 既存タスクへの詳細追加、または新規タスクの追加
   - タスクIDの採番規則に従う

8. **チェックリストの更新**:
   - `[x]` は「レビュー済み」を意味する
   - 反映された項目: `[x]` に変更し、末尾に `[RESOLVED]` を追記
   - 憲章でカバー済みの項目: `[x]` に変更し、末尾に `[COVERED]` を追記
   - 対応しないことを決定した項目: `[x]` に変更し、末尾に `[WONT_DO]` を追記
   - `[Spec §X.Y]` 参照が既にある項目: `[x]` のみ（追加マーカー不要）
   
   **マーカー凡例**:
   - `[RESOLVED]` - spec.md / plan.md / tasks.md のいずれかに反映済み
   - `[COVERED]` - 憲章でカバー済み
   - `[WONT_DO]` - 対応しないことを決定

9. **完了レポート**:
   ```
   ## チェックリストレビュー完了

   **対象チェックリスト**: ux.md
   **分析項目数**: 31
   **レビュー項目数**: 20
   **反映済み**: 8
   **スキップ**: 12

   **反映された項目**:
   | ID | 内容 | 反映先 |
   |----|------|-------|
   | CHK005 | ゼロ状態の表示要件 | spec.md §2.1 |
   | CHK006 | 視覚的区別の具体値 | plan.md スタイリング |
   | CHK011 | アニメーション実装 | tasks.md T005 |

   **スキップ/対応しない項目**:
   | ID | 理由 |
   |----|------|
   | CHK029 | [COVERED] 憲章でカバー済み |
   | CHK014 | [WONT_DO] MVP外 |

   **更新されたファイル**:
   - specs/001-xxx/spec.md
   - specs/001-xxx/plan.md
   - specs/001-xxx/checklists/ux.md

   **推奨される次のコマンド**: 
   - plan.mdがない場合: `/speckit.plan`
   - tasks.mdがない場合: `/speckit.tasks`
   - すべて揃っている場合: `/speckit.implement`
   ```

## 動作ルール

- チェックリストが存在しない場合、`/speckit.checklist` を先に実行するよう案内
- **すべての項目を無条件に反映しない** - 厳選が重要
- **バッチサイズ**: 5件ずつ詳細付きで表示
- **グループ表示順序**: spec.md → plan.md → tasks.md → 対応不要候補
- ユーザーの早期終了シグナル（"done"、"skip"、"next group"）を尊重
- 反映推奨項目が0の場合、「チェックリストはすべてレビュー済みです」と報告
- **⚠️ 必須**: 各項目に重要度に応じた候補を**必ず**生成する。空の候補は許可しない
- **⚠️ 必須**: 候補生成時はspec.md/constitution.mdのコンテキストを参照し、プロジェクトに適した提案を行う

**回答コマンド一覧**:
| コマンド | 説明 |
|----------|------|
| `recommended` | バッチ内の全項目を推奨オプションで反映 |
| `1B, 2A, 3C, 4A, 5D` | 項目ごとにオプション指定（A/B/C=反映、D=対応しない） |
| `next` | 次の5件へ（未回答は保留） |

**自由入力**: 項目番号と内容を記述すればカスタム反映（例: `3: タスクが空の場合は灰色の背景を表示`）

## 反映先判断フローチャート

```
項目を評価
    ↓
憲章でカバー済み？ → Yes → [COVERED]
    ↓ No
既に [Spec §X.Y] 参照あり？ → Yes → [x] のみ
    ↓ No
要件の欠落・曖昧さ？ → Yes → spec.md に反映
    ↓ No
技術的方針・設計決定？ → Yes → plan.md に反映（存在する場合）
    ↓ No
実装詳細・具体値？ → Yes → tasks.md に反映（存在する場合）
    ↓ No
対応不要？ → Yes → [WONT_DO]
    ↓ No
ユーザーに判断を委ねる
```

## 反映先が存在しない場合の対応

| 推奨反映先 | 存在しない場合 |
|-----------|---------------|
| plan.md | spec.mdに反映するか、スキップして `/speckit.plan` 後に再レビューを推奨 |
| tasks.md | plan.mdに反映するか、スキップして `/speckit.tasks` 後に再レビューを推奨 |
