---
description: タスク生成後にspec.md、plan.md、tasks.md間の非破壊的なクロスアーティファクト整合性と品質分析を実行します。
handoffs: 
  - label: speckit.implement
    agent: speckit.implement
    prompt: フェーズごとに実装を開始します
---

## ユーザー入力

```text
$ARGUMENTS
```

続行する前に、ユーザー入力を考慮する**必要があります**（空でない場合）。

## 目標

実装前に3つのコアアーティファクト（`spec.md`、`plan.md`、`tasks.md`）間の不整合、重複、曖昧さ、未指定項目を特定します。このコマンドは `/speckit.tasks` が完全な `tasks.md` を正常に生成した後にのみ実行する必要があります。

## 動作制約

**厳密に読み取り専用**: ファイルを**一切変更しないでください**。構造化された分析レポートを出力します。オプションの修正計画を提供します（フォローアップ編集コマンドを手動で呼び出す前に、ユーザーは明示的に承認する必要があります）。

**憲章の権威**: プロジェクト憲章（`.specify/memory/constitution.md`）はこの分析スコープ内で**交渉不可**です。憲章の競合は自動的にCRITICALとなり、原則の希薄化、再解釈、または暗黙の無視ではなく、仕様、計画、またはタスクの調整が必要です。原則自体を変更する必要がある場合は、`/speckit.analyze` の外で別途明示的な憲章更新として行う必要があります。

## 実行ステップ

### 1. 分析コンテキストを初期化

リポジトリルートから `.specify/scripts/bash/check-prerequisites.sh --json --require-tasks --include-tasks` を1回実行し、JSONをパースしてFEATURE_DIRとAVAILABLE_DOCSを取得。絶対パスを導出:

- SPEC = FEATURE_DIR/spec.md
- PLAN = FEATURE_DIR/plan.md
- TASKS = FEATURE_DIR/tasks.md

必要なファイルが欠落している場合はエラーメッセージで中止（ユーザーに欠落している前提条件コマンドを実行するよう指示）。
引数に "I'm Groot" のようなシングルクォートがある場合、エスケープ構文を使用: 例 'I'\''m Groot'（または可能なら二重引用符: "I'm Groot"）。

### 1.1. スタイルガイドを読み込み

`.specify/README.md` を読み込んで用語集とスタイルガイドを把握。
- セクション見出しには規定の絵文字を使用する
- 用語対応表に従って一貫した日本語表現を使用する
- 英語維持する特殊文字列（マーカー、ステータス、ファイル名等）は変換しない

### 2. アーティファクトを読み込み（段階的開示）

各アーティファクトから最小限必要なコンテキストのみを読み込み:

**spec.mdから:**

- 概要/コンテキスト
- 機能要件
- 非機能要件
- ユーザーストーリー
- エッジケース（存在する場合）

**plan.mdから:**

- アーキテクチャ/スタック選択
- データモデル参照
- フェーズ
- 技術的制約

**tasks.mdから:**

- タスクID
- 説明
- フェーズグループ
- 並列マーカー [P]
- 参照されるファイルパス

**憲章から:**

- 原則検証のために `.specify/memory/constitution.md` を読み込み

### 3. セマンティックモデルを構築

内部表現を作成（出力に生のアーティファクトを含めない）:

- **要件インベントリ**: 安定したキーを持つ各機能+非機能要件（命令形フレーズに基づいてスラッグを導出; 例: "ユーザーはファイルをアップロードできる" → `user-can-upload-file`）
- **ユーザーストーリー/アクションインベントリ**: 受入基準を持つ個別のユーザーアクション
- **タスクカバレッジマッピング**: 各タスクを1つ以上の要件またはストーリーにマッピング（キーワードによる推論/IDやキーフレーズなどの明示的な参照パターン）
- **憲章ルールセット**: 原則名とMUST/SHOULD規範的ステートメントを抽出

### 4. 検出パス（トークン効率的な分析）

高信号の発見に焦点を当てる。合計50件の発見に制限; 残りはオーバーフローサマリーで集約。

#### A. 重複検出

- ほぼ重複した要件を特定
- 統合のために低品質の言い回しをマーク

#### B. 曖昧さ検出

- 測定可能な基準のない曖昧な形容詞（高速、スケーラブル、セキュア、直感的、堅牢）をフラグ
- 未解決のプレースホルダー（TODO、TKTK、???、`<placeholder>` など）をフラグ

#### C. 未指定

- 動詞はあるがオブジェクトまたは測定可能な結果が欠落している要件
- 受入基準の整合性が欠落しているユーザーストーリー
- spec/planで定義されていないファイルまたはコンポーネントを参照するタスク

#### D. 憲章整合性

- MUST原則と競合する要件または計画要素
- 憲章からの必須セクションまたは品質ゲートの欠落

#### E. カバレッジギャップ

- 関連タスクがゼロの要件
- マッピングされた要件/ストーリーのないタスク
- タスクに反映されていない非機能要件（例: パフォーマンス、セキュリティ）

#### F. 不整合

- 用語のドリフト（同じ概念がファイル間で異なる名前）
- planで参照されているがspecにないデータエンティティ（またはその逆）
- タスク順序の矛盾（例: 依存関係の注記なしに基盤セットアップタスクの前に統合タスク）
- 競合する要件（例: 一方がNext.jsを要求し、他方がVueを指定）

### 5. 重大度の割り当て

この発見的手法を使用して発見を優先順位付け:

- **CRITICAL**: 憲章MUSTに違反、コアspecアーティファクトの欠落、またはベースライン機能をブロックするカバレッジゼロの要件
- **HIGH**: 重複または競合する要件、曖昧なセキュリティ/パフォーマンス属性、テスト不可能な受入基準
- **MEDIUM**: 用語のドリフト、非機能タスクカバレッジの欠落、未指定のエッジケース
- **LOW**: スタイル/言い回しの改善、実行順序に影響しない軽微な冗長性

### 6. コンパクトな分析レポートを作成

以下の構造でMarkdownレポートを出力（ファイル書き込みなし）:

## 仕様分析レポート

| ID | カテゴリ | 重大度 | 場所 | サマリー | 推奨事項 |
|----|----------|--------|------|----------|----------|
| A1 | 重複 | HIGH | spec.md:L120-134 | 2つの類似した要件 ... | 言い回しを統合; より明確なバージョンを保持 |

（発見ごとに1行追加; カテゴリの頭文字をプレフィックスとした安定したIDを生成。）

**カバレッジサマリーテーブル:**

| 要件キー | タスクあり? | タスクID | 注記 |
|----------|-------------|----------|------|

**憲章整合性の問題:** （ある場合）

**マッピングされていないタスク:** （ある場合）

**メトリクス:**

- 合計要件数
- 合計タスク数
- カバレッジ %（1つ以上のタスクを持つ要件）
- 曖昧さ数
- 重複数
- 重大な問題数

### 7. 次のアクションを提供

レポートの最後に、簡潔な次のアクションブロックを出力:

- CRITICALの問題が存在する場合: `/speckit.implement` の前に解決することを推奨
- LOW/MEDIUMのみの場合: ユーザーは続行可能だが、改善提案を提供
- 明示的なコマンド提案を提供: 例: "改良して /speckit.specify を実行"、"アーキテクチャを調整するために /speckit.plan を実行"、"'performance-metrics'のカバレッジを追加するためにtasks.mdを手動編集"

### 8. 修正を提案

ユーザーに質問: "上位N件の問題に対する具体的な修正編集を提案しましょうか？"（自動的には適用しないでください。）

## 動作原則

### コンテキスト効率

- **最小限の高信号トークン**: 網羅的なドキュメントではなく、アクション可能な発見に焦点
- **段階的開示**: アーティファクトを段階的に読み込み; すべてのコンテンツを分析にダンプしない
- **トークン効率的な出力**: 発見テーブルを50行に制限; オーバーフローを要約
- **決定論的な結果**: 変更なしで再実行すると一貫したIDとカウントが生成される

### 分析ガイドライン

- ファイルを**決して変更しない**（これは読み取り専用分析）
- 欠落しているセクションを**決して捏造しない**（欠落している場合は正確に報告）
- 憲章違反を**優先**（これらは常にCRITICAL）
- 網羅的なルールより**具体例を使用**（一般的なパターンではなく特定のインスタンスを引用）
- 問題がゼロの場合は**優雅に報告**（カバレッジ統計を含む成功レポートを出力）

## コンテキスト

$ARGUMENTS