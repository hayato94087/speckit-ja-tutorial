---
description: 利用可能な設計成果物に基づいて、アクション可能な依存関係順のtasks.mdを生成します。
handoffs: 
  - label: 整合性を分析
    agent: speckit.analyze
    prompt: 整合性のためにプロジェクト分析を実行します
    send: true
  - label: チェックリストをレビュー
    agent: speckit.checklist-review
    prompt: チェックリストの項目をレビューし、spec/plan/tasksに反映します
  - label: プロジェクトを実装
    agent: speckit.implement
    prompt: フェーズごとに実装を開始します
    send: true
---

## ユーザー入力

```text
$ARGUMENTS
```

続行する前に、ユーザー入力を考慮する**必要があります**（空でない場合）。

## 概要

1. **セットアップ**: リポジトリルートから `.specify/scripts/bash/check-prerequisites.sh --json` を実行し、FEATURE_DIRとAVAILABLE_DOCSリストをパース。すべてのパスは絶対パスである必要があります。引数に "I'm Groot" のようなシングルクォートがある場合、エスケープ構文を使用: 例 'I'\''m Groot'（または可能なら二重引用符: "I'm Groot"）。

2. **設計ドキュメントを読み込み**: FEATURE_DIRから読み込み:
   - **必須**: plan.md（技術スタック、ライブラリ、構造）、spec.md（優先度付きユーザーストーリー）
   - **オプション**: data-model.md（エンティティ）、contracts/（APIエンドポイント）、research.md（決定事項）、quickstart.md（テストシナリオ）
   - 注意: すべてのプロジェクトがすべてのドキュメントを持っているわけではありません。利用可能なものに基づいてタスクを生成してください。

3. **スタイルガイドを読み込み**: `.specify/README.md` を読み込んで用語集とスタイルガイドを把握。
   - セクション見出しには規定の絵文字を使用する
   - 用語対応表に従って一貫した日本語表現を使用する
   - 英語維持する特殊文字列（マーカー、ステータス、ファイル名等）は変換しない

4. **タスク生成ワークフローを実行**:
   - plan.mdを読み込み、技術スタック、ライブラリ、プロジェクト構造を抽出
   - spec.mdを読み込み、優先度（P1、P2、P3など）付きユーザーストーリーを抽出
   - data-model.mdが存在する場合: エンティティを抽出しユーザーストーリーにマッピング
   - contracts/が存在する場合: エンドポイントをユーザーストーリーにマッピング
   - research.mdが存在する場合: セットアップタスク用の決定事項を抽出
   - ユーザーストーリーごとに整理されたタスクを生成（下記のタスク生成ルールを参照）
   - ユーザーストーリーの完了順序を示す依存関係グラフを生成
   - ユーザーストーリーごとの並列実行例を作成
   - タスクの完全性を検証（各ユーザーストーリーに必要なすべてのタスクがあり、独立してテスト可能）

5. **tasks.mdを生成**: `.specify/templates/tasks-template.md` を構造として使用し、以下を記入:
   - plan.mdからの正しい機能名
   - Phase 1: セットアップタスク（プロジェクト初期化）
   - Phase 2: 基盤タスク（すべてのユーザーストーリーのブロッキング前提条件）
   - Phase 3+: ユーザーストーリーごとに1フェーズ（spec.mdの優先度順）
   - 各フェーズに含めるもの: ストーリーゴール、独立したテスト基準、テスト（要求された場合）、実装タスク
   - 最終フェーズ: 仕上げと横断的関心事
   - すべてのタスクは厳格なチェックリスト形式に従う必要がある（下記のタスク生成ルールを参照）
   - 各タスクの明確なファイルパス
   - ストーリー完了順序を示す依存関係セクション
   - ストーリーごとの並列実行例
   - 実装戦略セクション（MVP優先、インクリメンタルデリバリー）

6. **報告**: 生成されたtasks.mdへのパスとサマリーを出力:
   - 合計タスク数
   - ユーザーストーリーごとのタスク数
   - 特定された並列機会
   - 各ストーリーの独立したテスト基準
   - 推奨MVPスコープ（通常はユーザーストーリー1のみ）
   - フォーマット検証: すべてのタスクがチェックリスト形式（チェックボックス、ID、ラベル、ファイルパス）に従っていることを確認

タスク生成のコンテキスト: $ARGUMENTS

tasks.mdは即座に実行可能である必要があります - 各タスクは追加のコンテキストなしでLLMが完了できるほど具体的である必要があります。

## タスク生成ルール

**重要**: タスクは独立した実装とテストを可能にするため、ユーザーストーリーごとに整理される必要があります。

**テストはオプション**: 機能仕様で明示的に要求された場合、またはユーザーがTDDアプローチを要求した場合にのみテストタスクを生成します。

### チェックリスト形式（必須）

すべてのタスクは以下の形式に厳密に従う必要があります:

```text
- [ ] [TaskID] [P?] [Story?] ファイルパス付きの説明
```

**形式コンポーネント**:

1. **チェックボックス**: 常に `- [ ]`（マークダウンチェックボックス）で開始
2. **タスクID**: 実行順の連番（T001、T002、T003...）
3. **[P]マーカー**: タスクが並列化可能な場合のみ含める（異なるファイル、未完了タスクへの依存なし）
4. **[Story]ラベル**: ユーザーストーリーフェーズのタスクにのみ必須
   - 形式: [US1]、[US2]、[US3]など（spec.mdのユーザーストーリーにマッピング）
   - セットアップフェーズ: ストーリーラベルなし
   - 基盤フェーズ: ストーリーラベルなし
   - ユーザーストーリーフェーズ: ストーリーラベル必須
   - 仕上げフェーズ: ストーリーラベルなし
5. **説明**: 正確なファイルパス付きの明確なアクション

**例**:

- ✅ 正しい: `- [ ] T001 実装計画に従ってプロジェクト構造を作成`
- ✅ 正しい: `- [ ] T005 [P] src/middleware/auth.pyに認証ミドルウェアを実装`
- ✅ 正しい: `- [ ] T012 [P] [US1] src/models/user.pyにUserモデルを作成`
- ✅ 正しい: `- [ ] T014 [US1] src/services/user_service.pyにUserServiceを実装`
- ❌ 間違い: `- [ ] Userモデルを作成`（IDとStoryラベルが欠落）
- ❌ 間違い: `T001 [US1] モデルを作成`（チェックボックスが欠落）
- ❌ 間違い: `- [ ] [US1] Userモデルを作成`（タスクIDが欠落）
- ❌ 間違い: `- [ ] T001 [US1] モデルを作成`（ファイルパスが欠落）

### タスクの整理

1. **ユーザーストーリー（spec.md）から** - 主要な整理:
   - 各ユーザーストーリー（P1、P2、P3...）が独自のフェーズを取得
   - すべての関連コンポーネントをストーリーにマッピング:
     - そのストーリーに必要なモデル
     - そのストーリーに必要なサービス
     - そのストーリーに必要なエンドポイント/UI
     - テストが要求された場合: そのストーリー固有のテスト
   - ストーリーの依存関係をマーク（ほとんどのストーリーは独立すべき）

2. **コントラクトから**:
   - 各コントラクト/エンドポイント → それが提供するユーザーストーリーにマッピング
   - テストが要求された場合: 各コントラクト → そのストーリーのフェーズでの実装前にコントラクトテストタスク [P]

3. **データモデルから**:
   - 各エンティティをそれを必要とするユーザーストーリーにマッピング
   - エンティティが複数のストーリーに提供する場合: 最も早いストーリーまたはセットアップフェーズに配置
   - リレーション → 適切なストーリーフェーズのサービスレイヤータスク

4. **セットアップ/インフラストラクチャから**:
   - 共有インフラストラクチャ → セットアップフェーズ（Phase 1）
   - 基盤/ブロッキングタスク → 基盤フェーズ（Phase 2）
   - ストーリー固有のセットアップ → そのストーリーのフェーズ内

### フェーズ構造

tasks.mdでは `## 🚀 3. Phase` の配下にすべてのフェーズを `###` サブセクションとして配置:

- **Phase 1**: セットアップ（プロジェクト初期化）
- **Phase 2**: 基盤（ブロッキング前提条件 - ユーザーストーリーの前に完了必須）
- **Phase 3〜7**: 優先度順のユーザーストーリー
  - `### Phase 3: US1 - [タイトル] [P1]` - spec.md §2.1と対応
  - `### Phase 4: US2 - [タイトル] [P2]` - spec.md §2.2と対応
  - `### Phase 5: US3 - [タイトル] [P3]` - spec.md §2.3と対応
  - 各フェーズは完全で独立してテスト可能なインクリメントである必要がある
- **Phase 8**: 仕上げと横断的関心事

**重要**: 
- US番号はspec.mdのセクション番号と対応させる（US1 = §2.1, US2 = §2.2 ...）
- US内のテスト/実装は `####` レベルの見出しを使用
