# 実行計画

| 項目 | 値 |
| --- | --- |
| **機能名** | 個人用 ToDo アプリ |
| **ブランチ** | `001-personal-todo` |
| **日付** | 2026-02-03 |
| **仕様** | [spec.md](spec.md) |
| **入力** | `/specs/001-personal-todo/spec.md` |

## 📑 目次

<!-- 目次ルール: ##（h2）と ###（h3）レベルの見出しまで含め、番号を付与する -->

- [1. 概要](#-1-概要)
- [2. 技術コンテキスト](#-2-技術コンテキスト)
- [3. 憲章チェック](#-3-憲章チェック)
- [4. プロジェクト構造](#-4-プロジェクト構造)
  - [4.1 ドキュメント（この機能）](#41-ドキュメントこの機能)
  - [4.2 ソースコード（リポジトリルート）](#42-ソースコードリポジトリルート)
- [5. マイルストーン](#-5-マイルストーン)
- [6. フェーズ詳細](#-6-フェーズ詳細)
  - [6.1 Phase 1: 基盤セットアップ](#61-phase-1-基盤セットアップ)
  - [6.2 Phase 2: データモデル・永続化](#62-phase-2-データモデル永続化)
  - [6.3 Phase 3: コアUI実装](#63-phase-3-コアui実装)
  - [6.4 Phase 4: フィルタ・仕上げ](#64-phase-4-フィルタ仕上げ)
  - [6.5 Phase 5: テスト・品質保証](#65-phase-5-テスト品質保証)
- [7. 受け入れ条件マッピング](#-7-受け入れ条件マッピング)
- [8. 手動動作確認チェックリスト](#-8-手動動作確認チェックリスト)
- [9. リスク・未決事項](#-9-リスク未決事項)
- [10. 複雑性の追跡](#-10-複雑性の追跡)

## 📋 1. 概要

個人用のオフラインファーストToDoアプリを構築する。

**主要要件**:
- タスクの追加/完了切替/編集/削除
- フィルタリング（すべて/未完了/完了済み）
- localStorageによるデータ永続化（破損・旧形式からの安全復旧）
- キーボード操作対応を含むa11y要件
- モバイルファーストのレスポンシブデザイン

**技術アプローチ**:
- Next.js（App Router）+ Tailwind CSS + shadcn/ui
- クライアントサイド完結型（オフライン優先）
- Unit/E2Eテスト必須

## 🔧 2. 技術コンテキスト

**言語/バージョン**: TypeScript 5.x, Node.js 20.x LTS  
**主要な依存関係**: Next.js 14+ (App Router), React 18+, Tailwind CSS 3.x, shadcn/ui  
**ストレージ**: localStorage（破損/旧形式への安全復旧含む）  
**テスト**: Vitest（Unit）, Playwright（E2E）  
**ターゲットプラットフォーム**: モダンブラウザ（デスクトップ・モバイル）  
**プロジェクトタイプ**: web（Next.js単体）  
**パフォーマンス目標**: すべての操作が0.3秒以内、1,000件のタスクでも劣化なし  
**制約**: オフライン動作必須、localStorage容量上限（5MB目安）  
**スケール/スコープ**: 個人利用、最大1,000タスク、単一画面

## ✅ 3. 憲章チェック

*ゲート: フェーズ0調査前に合格が必要。フェーズ1設計後に再確認。*

| 原則 | 要件 | 状態 | 備考 |
|------|------|------|------|
| **1.1 クリーンコード** | 可読性・シンプルさ・一貫性・関心の分離・DRY | ✅ PASS | React Hooks + カスタムフック分離で対応 |
| **1.2 シンプルなUX** | 直感的・最小操作・明確なフィードバック・一貫したUI | ✅ PASS | shadcn/uiで統一UI、1-2アクション導線 |
| **1.3 レスポンシブデザイン** | モバイルファースト、Tailwindブレークポイント、44x44pxタップ領域 | ✅ PASS | Tailwind CSS + shadcn/ui準拠 |
| **1.4 テストコード不要** | Unit/Integration/E2Eテスト不要 | ⚠️ 要調整 | **仕様でテスト必須のため、憲章より仕様を優先** |
| **2. 技術スタック** | Next.js, React, Tailwind CSS, shadcn/ui | ✅ PASS | 完全準拠 |
| **3. 命名規則** | ファイルkebab-case、コードPascalCase/camelCase | ✅ PASS | 規則に従う |

**憲章との差異（正当化）**:

憲章「1.4 テストコード不要」と仕様の「テスト必須」が矛盾する。本機能ではユーザー要件（仕様）を優先し、Unit/E2Eテストを実装する。理由：
1. データ永続化・復旧ロジックの信頼性がアプリの価値に直結
2. a11y要件の自動検証が品質担保に必須
3. 手動検証のみでは1,000件規模のパフォーマンステストが困難

## 📁 4. プロジェクト構造

### 4.1 ドキュメント（この機能）

```text
specs/001-personal-todo/
├── spec.md              # 機能仕様
├── plan.md              # このファイル（実行計画）
├── research.md          # Phase 0の出力（技術調査）
├── data-model.md        # Phase 1の出力（データモデル設計）
├── quickstart.md        # Phase 1の出力（開発環境セットアップ）
├── contracts/           # Phase 1の出力（コンポーネントコントラクト）
│   └── components.md    # コンポーネントI/F定義
├── checklists/
│   └── requirements.md  # 要件チェックリスト
└── tasks.md             # Phase 2の出力（タスク分解）
```

### 4.2 ソースコード（リポジトリルート）

```text
src/
├── app/
│   ├── layout.tsx           # ルートレイアウト
│   ├── page.tsx             # メインページ（ToDoアプリ）
│   └── globals.css          # グローバルスタイル（Tailwind）
├── components/
│   ├── ui/                  # shadcn/ui コンポーネント
│   │   ├── button.tsx
│   │   ├── input.tsx
│   │   ├── checkbox.tsx
│   │   └── ...
│   ├── todo/
│   │   ├── todo-app.tsx         # メインコンテナ
│   │   ├── todo-input.tsx       # タスク入力フォーム
│   │   ├── todo-list.tsx        # タスク一覧
│   │   ├── todo-item.tsx        # 個別タスク
│   │   ├── todo-filter.tsx      # フィルタUI
│   │   └── todo-empty.tsx       # 空状態表示
│   └── feedback/
│       ├── toast.tsx            # 通知表示
│       └── error-boundary.tsx   # エラーハンドリング
├── hooks/
│   ├── use-todos.ts             # ToDoのCRUD・状態管理
│   ├── use-local-storage.ts     # localStorage抽象化
│   └── use-filter.ts            # フィルタ状態管理
├── lib/
│   ├── storage.ts               # ストレージユーティリティ
│   ├── migration.ts             # データ移行・復旧ロジック
│   ├── validation.ts            # 入力バリデーション
│   └── utils.ts                 # 汎用ユーティリティ
└── types/
    └── todo.ts                  # 型定義

tests/
├── unit/
│   ├── hooks/
│   │   ├── use-todos.test.ts
│   │   └── use-local-storage.test.ts
│   └── lib/
│       ├── storage.test.ts
│       ├── migration.test.ts
│       └── validation.test.ts
└── e2e/
    ├── todo-crud.spec.ts        # 追加/編集/削除
    ├── todo-complete.spec.ts    # 完了切替
    ├── todo-filter.spec.ts      # フィルタ
    ├── todo-persistence.spec.ts # 永続化・復旧
    └── todo-a11y.spec.ts        # アクセシビリティ
```

**構造の決定**: Next.js App Router単体構成を採用。コンポーネントは機能別（todo/, feedback/）に分離し、ビジネスロジックはカスタムフック（hooks/）とユーティリティ（lib/）に切り出す。

## 🎯 5. マイルストーン

| Phase | 名称 | 目的 | 完了条件 | 対応US |
|-------|------|------|----------|--------|
| 1 | 基盤セットアップ | 開発環境・ツールチェーン構築 | ビルド成功、shadcn/ui動作確認 | - |
| 2 | データモデル・永続化 | ストレージ層の実装 | Unit通過、復旧ロジック動作 | US5 |
| 3 | コアUI実装 | 追加/完了/編集/削除 | E2E通過、a11y確認 | US1,US2,US3 |
| 4 | フィルタ・仕上げ | フィルタ・UX改善 | E2E通過、レスポンシブ確認 | US4 |
| 5 | テスト・品質保証 | 全テスト通過・最終確認 | 全AC達成、手動チェック完了 | 全US |

## 📝 6. フェーズ詳細

### 6.1 Phase 1: 基盤セットアップ

**目的**: 開発環境とツールチェーンを構築し、開発を開始できる状態にする

**作業内容**:
1. Next.js プロジェクト作成（App Router, TypeScript, Tailwind CSS）
2. pnpm 設定・依存関係インストール
3. shadcn/ui 初期化・基本コンポーネント追加（Button, Input, Checkbox）
4. Vitest + Playwright セットアップ
5. ESLint/Prettier 設定
6. 基本レイアウト・空のToDoアプリコンポーネント作成

**Done条件**:
- [ ] `pnpm dev` でローカル起動成功
- [ ] `pnpm build` でプロダクションビルド成功
- [ ] shadcn/ui Buttonが表示される
- [ ] `pnpm test` でVitestが実行できる
- [ ] `pnpm test:e2e` でPlaywrightが実行できる

**影響ファイル**:
- `package.json`, `pnpm-lock.yaml`
- `next.config.js`, `tsconfig.json`, `tailwind.config.ts`
- `vitest.config.ts`, `playwright.config.ts`
- `src/app/layout.tsx`, `src/app/page.tsx`
- `src/components/ui/*.tsx`

### 6.2 Phase 2: データモデル・永続化

**目的**: localStorageを使ったデータ永続化と破損/旧形式からの復旧を実装

**作業内容**:
1. Task型定義（id, title, completed, createdAt, updatedAt）
2. localStorageユーティリティ作成（読み書き・エラーハンドリング）
3. データバリデーション（Zod使用）
4. マイグレーション/復旧ロジック
   - 破損JSON → 空データ + 警告
   - 旧形式 → 変換試行 → 失敗時は空データ + 警告
5. useTodosフック（CRUD操作）
6. Unit テスト作成

**Done条件**:
- [ ] Task型がバリデーション付きで定義されている
- [ ] localStorage読み書きが正常に動作
- [ ] 破損JSONでクラッシュせず警告表示
- [ ] 旧形式データのマイグレーションが動作
- [ ] Unit テスト全件通過

**影響ファイル**:
- `src/types/todo.ts`
- `src/lib/storage.ts`, `src/lib/migration.ts`, `src/lib/validation.ts`
- `src/hooks/use-todos.ts`, `src/hooks/use-local-storage.ts`
- `tests/unit/lib/*.test.ts`, `tests/unit/hooks/*.test.ts`

### 6.3 Phase 3: コアUI実装

**目的**: タスクの追加/完了切替/編集/削除のUIを実装

**作業内容**:
1. **タスク追加（US1）**
   - TodoInput: 入力フォーム + 追加ボタン
   - 空文字/255文字制限バリデーション
   - Enter キーで追加、追加後クリア
   - aria-label, フォーカス管理

2. **完了切替（US2）**
   - TodoItem: チェックボックス + タスク名表示
   - 完了時は取り消し線スタイル
   - Space/Enter で切替
   - 状態変更時のスクリーンリーダー通知

3. **編集/削除（US3）**
   - インライン編集モード
   - Escape でキャンセル、Enter で保存
   - 削除ボタン（視覚的フィードバック）
   - 誤操作対策: Undo通知 or 確認UI

4. **一覧表示**
   - TodoList: 0件時のメッセージ
   - キーボードナビゲーション（矢印キー）

5. **a11y対応**
   - フォーカス可視化（ring）
   - 適切なaria-label
   - 状態変更時のlive region通知

**Done条件**:
- [ ] タスク追加が動作（空文字拒否、Enter対応）
- [ ] 完了切替が動作（視覚的区別あり）
- [ ] 編集が動作（キャンセル可能）
- [ ] 削除が動作（フィードバックあり）
- [ ] キーボードのみで全操作可能
- [ ] モバイル幅でタップ操作可能
- [ ] E2E テスト通過

**影響ファイル**:
- `src/components/todo/*.tsx`
- `src/components/feedback/*.tsx`
- `tests/e2e/todo-crud.spec.ts`, `tests/e2e/todo-complete.spec.ts`
- `tests/e2e/todo-a11y.spec.ts`

### 6.4 Phase 4: フィルタ・仕上げ

**目的**: フィルタ機能と全体的なUX改善

**作業内容**:
1. **フィルタ機能（US4）**
   - TodoFilter: すべて/未完了/完了済み切替
   - フィルタ状態のlocalStorage保存（任意）
   - 件数表示
   - キーボード操作対応

2. **UX改善**
   - ローディング状態
   - エラー境界
   - 複数タブ検知（storage event）
   - 容量上限警告

3. **レスポンシブ対応最終確認**
   - 320px幅での動作確認
   - 44x44pxタップ領域確保

**Done条件**:
- [ ] 3種のフィルタが正常動作
- [ ] フィルタ切替がキーボードで可能
- [ ] 複数タブでの変更検知
- [ ] 320px幅で全機能動作
- [ ] E2E テスト通過

**影響ファイル**:
- `src/components/todo/todo-filter.tsx`
- `src/hooks/use-filter.ts`
- `tests/e2e/todo-filter.spec.ts`

### 6.5 Phase 5: テスト・品質保証

**目的**: 全テスト通過と最終品質確認

**作業内容**:
1. 全Unit テスト実行・修正
2. 全E2E テスト実行・修正
3. Lighthouse a11yスコア確認
4. パフォーマンス確認（1,000件タスク）
5. 手動チェックリスト実行
6. ドキュメント最終確認

**Done条件**:
- [ ] Unit テスト100%通過
- [ ] E2E テスト100%通過
- [ ] Lighthouse a11y スコア90+
- [ ] 1,000件タスクで0.3秒以内応答
- [ ] 手動チェックリスト全項目完了

**影響ファイル**:
- テストファイル全般
- ドキュメント

## ✅ 7. 受け入れ条件マッピング

| Step | 対応AC | 説明 |
|------|--------|------|
| Phase 2 | US5-1,2,3,4,5 | データ永続化・復旧全般 |
| Phase 3.1 | US1-1,2,3,4,5 | タスク追加機能 |
| Phase 3.2 | US2-1,2,3,4,5 | 完了切替機能 |
| Phase 3.3 | US3-1,2,3,4,5,6 | 編集/削除機能 |
| Phase 4.1 | US4-1,2,3,4,5,6 | フィルタ機能 |
| Phase 5 | 全SC（成功基準） | 品質保証 |

## ✅ 8. 手動動作確認チェックリスト

### 8.1 基本機能

- [ ] **追加→リロード→復元**: タスクを追加し、ブラウザをリロードして復元される
- [ ] **完了/未完了切替**: チェックボックスで切替、視覚的に区別される
- [ ] **編集（保存）**: タスク名を編集し、Enter で保存される
- [ ] **編集（キャンセル）**: 編集中に Escape で元に戻る
- [ ] **削除**: タスクを削除し、一覧から消える
- [ ] **削除の誤操作対策**: 削除後に Undo 通知、または確認UIがある

### 8.2 フィルタ

- [ ] 「すべて」でタスク全件表示
- [ ] 「未完了」で未完了タスクのみ表示
- [ ] 「完了済み」で完了タスクのみ表示
- [ ] フィルタ切替後もリロードで状態維持（任意）

### 8.3 データ堅牢性

- [ ] **破損データ**: localStorage に不正 JSON を直接設定し、アプリを開いてもクラッシュしない
- [ ] **旧形式データ**: 旧形式（idがnumber等）を設定し、変換または警告が表示される
- [ ] **容量警告**: ストレージ上限に近い状態で警告が表示される（手動確認困難なら省略可）

### 8.4 アクセシビリティ

- [ ] **Tab キーで全要素にフォーカス移動**: 入力→追加→各タスク→フィルタの順
- [ ] **フォーカス可視化**: フォーカス時に視覚的なリングが表示される
- [ ] **Enter/Space でアクション実行**: ボタン・チェックボックスが操作できる
- [ ] **Escape でキャンセル**: 編集モード終了
- [ ] **スクリーンリーダーでラベル読み上げ**: VoiceOver/NVDAで確認（可能な範囲）

### 8.5 レスポンシブ

- [ ] **320px幅**: DevToolsでモバイル幅にして全機能が操作可能
- [ ] **タップ領域**: ボタン・チェックボックスが指でタップしやすいサイズ

### 8.6 パフォーマンス

- [ ] **1,000件タスク**: コンソールからタスクを1,000件追加し、操作が0.3秒以内

## ⚠️ 9. リスク・未決事項

| # | 項目 | リスク/影響 | 対応方針 | 決定順序 |
|---|------|-----------|----------|----------|
| 1 | テスト必須 vs 憲章不要 | 開発工数増加 | **仕様優先**（既に決定） | 決定済み |
| 2 | 削除の誤操作対策 | Undo vs 確認ダイアログ | Undo通知採用（UXシンプル） | Phase 3開始前 |
| 3 | 旧形式の定義 | マイグレーション対象不明 | v1として現形式を定義、将来の互換性のみ考慮 | Phase 2開始前 |
| 4 | E2Eテストのブラウザ | 複数ブラウザ対応 | Chromiumのみ（MVP） | Phase 1 |
| 5 | フィルタ状態の永続化 | リロード後の状態 | 任意（実装コスト低いなら対応） | Phase 4 |

## 📊 10. 複雑性の追跡

| 違反 | 必要な理由 | よりシンプルな代替案を却下した理由 |
|------|----------|-----------------------------------|
| テストコード追加（憲章違反） | データ永続化・復旧の信頼性、a11y自動検証、1000件パフォーマンス検証 | 手動テストのみでは回帰検出困難、仕様で明示的に必須 |
