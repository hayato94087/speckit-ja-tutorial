# 実行計画

| 項目 | 値 |
| --- | --- |
| **機能名** | 品質ゲート |
| **ブランチ** | `002-quality-gates` |
| **日付** | 2026-02-04 |
| **仕様** | [spec.md](spec.md) |
| **入力** | `/specs/002-quality-gates/spec.md` |

## 📑 目次

<!-- 目次ルール: ##（h2）と ###（h3）レベルの見出しまで含め、番号を付与する -->

- [1. 概要](#-1-概要)
- [2. 技術コンテキスト](#-2-技術コンテキスト)
- [3. 憲章チェック](#-3-憲章チェック)
- [4. プロジェクト構造](#-4-プロジェクト構造)
  - [4.1 ドキュメント（この機能）](#41-ドキュメントこの機能)
  - [4.2 ソースコード（リポジトリルート）](#42-ソースコードリポジトリルート)
- [5. 複雑性の追跡](#-5-複雑性の追跡)
- [6. マイルストーン](#-6-マイルストーン)
- [7. 品質ゲート実行手順](#-7-品質ゲート実行手順)
  - [7.1 ローカル実行](#71-ローカル実行)
  - [7.2 推奨ワークフロー](#72-推奨ワークフロー)
  - [7.3 証跡の取得タイミング](#73-証跡の取得タイミング)
- [8. リスクと対策](#-8-リスクと対策)

## 📋 1. 概要

品質ゲートを整備し、コードの品質を継続的に担保する仕組みを構築する。

**主要要件**:
- 型チェック、リント、フォーマットチェックを実行可能にする
- Unitテストでロジック（バリデーション、フィルタ、ストレージ等）を検証する
- E2Eテストで主要導線（CRUD、フィルタ、永続化）を検証する
- 既存のToDo機能（001-personal-todo）を維持する

**技術アプローチ**:
- TypeScript: 型チェック（`tsc --noEmit`）
- ESLint: リント（Next.js推奨設定）
- Prettier: フォーマット
- Vitest: Unitテスト（高速、React対応）
- Playwright: E2Eテスト（スクリーンショット・動画取得対応）

## 🔧 2. 技術コンテキスト

**言語/バージョン**: TypeScript 5.x、Node.js 20+
**主要な依存関係**: Next.js 16.x、React 19.x、Tailwind CSS 4.x、shadcn/ui
**ストレージ**: localStorage（クライアントサイド永続化）
**テスト**: Vitest（Unit）、Playwright（E2E）
**ターゲットプラットフォーム**: Webブラウザ（Chrome、Firefox、Safari）
**プロジェクトタイプ**: single（Next.js App Router）
**パフォーマンス目標**: 品質ゲート全体で10分以内（シリアル実行時）
**制約**: CI/CDパイプライン構築はスコープ外
**規模/スコープ**: 1,000ファイル未満、100テストケース未満

## ✅ 3. 憲章チェック

*ゲート: フェーズ0調査前に合格が必要。フェーズ1設計後に再確認。*

| 原則 | ステータス | 説明 |
|------|---------|------|
| 1.1 クリーンコード | ✓ PASS | リント・フォーマットで一貫性を担保 |
| 1.2 シンプルなUX | ✓ PASS | 既存UI変更なし |
| 1.3 レスポンシブデザイン | ✓ PASS | 既存レスポンシブ維持 |
| 1.4 テスト規律 | ✓ PASS | Vitest（Unit）+ Playwright（E2E）を採用 |

| 技術スタック | ステータス | 説明 |
|-------------|---------|------|
| TypeScript | ✓ PASS | 既存設定を継続使用 |
| ESLint | ✓ PASS | eslint-config-next使用 |
| Prettier | ✓ PASS | フォーマッター追加 |
| Vitest | ✓ PASS | 既存設定を継続使用 |
| Playwright | ✓ PASS | 既存設定にスクリーンショット・動画を追加 |

| 品質ゲート | ステータス | 説明 |
|-----------|---------|------|
| 型チェック | ✓ PASS | `npm run type-check` 追加 |
| リント | ✓ PASS | 既存 `npm run lint` 使用 |
| フォーマット | ✓ PASS | `npm run format:check` 追加 |
| Unitテスト | ✓ PASS | 既存 `npm run test` 使用 |
| E2Eテスト | ✓ PASS | 既存 `npm run test:e2e` 使用 |

**結論**: すべてのゲートに合格。計画を進行可能。

## 📁 4. プロジェクト構造

### 4.1 ドキュメント（この機能）

```text
specs/002-quality-gates/
├── spec.md              # 機能仕様（入力）
├── plan.md              # このファイル（実行計画）
├── research.md          # リサーチ結果（Phase 0）
├── data-model.md        # データモデル（Phase 1）- この機能ではN/A
├── quickstart.md        # クイックスタート（Phase 1）
└── tasks.md             # タスクリスト（Phase 2 - speckit.tasksで生成）
```

### 4.2 ソースコード（リポジトリルート）

```text
# 単一プロジェクト: Next.js App Router
src/
├── app/                # App Routerページ
├── components/         # UIコンポーネント
├── hooks/              # カスタムフック（use-todos, use-filter等）
├── lib/                # ユーティリティ（validation, storage, migration等）
└── types/              # 型定義

tests/
├── setup.ts            # テストセットアップ
├── unit/               # Unitテスト
│   ├── hooks/          # フックのテスト
│   └── lib/            # ユーティリティのテスト
└── e2e/                # E2Eテスト
    ├── todo-crud.spec.ts
    ├── todo-complete.spec.ts
    ├── todo-filter.spec.ts
    ├── todo-persistence.spec.ts
    └── ...
```

**構造の決定**: 既存のNext.js App Router構造を維持。テストディレクトリ構造も既存を継続。

## 📊 5. 複雑性の追跡

> **憲章チェックに正当化が必要な違反がある場合のみ記入**

該当なし。すべての設計は憲章に準拠している。

## 🎯 6. マイルストーン

### マイルストーン1: ツール導入と品質ゲート整備

**目標**: 品質ゲートの基盤を構築する

| タスク | 説明 | Done条件 |
|--------|------|---------|
| Prettier導入 | `.prettierrc`、`.prettierignore`を追加 | `npm run format:check` が成功する |
| npm scripts追加 | `type-check`、`format`、`format:check`、`check-all`を追加 | 各コマンドが正常に実行される |
| Playwright設定拡張 | スクリーンショット・動画・トレース設定を追加 | E2E実行後に証跡が生成される |

**証跡**:
- `npm run format:check` の成功ログ
- `npm run type-check` の成功ログ
- E2Eテスト後の `test-results/` 内のスクリーンショット・動画

### マイルストーン2: Unitテスト追加・検証

**目標**: ロジックのUnitテストカバレッジを確保する

| タスク | 説明 | Done条件 |
|--------|------|---------|
| 既存Unitテスト確認 | validation, storage, migration, task-factory, hooksのテストを確認 | 全テストがPASSする |
| 不足テスト追加 | フィルタロジックなど不足しているテストを追加 | すべてのユースケースがカバーされる |
| カバレッジ確認 | 重要ロジックのカバレッジを確認 | 80%以上のカバレッジ（目標） |

**証跡**:
- `npm run test:run` の成功ログ（全テストPASS）
- Vitestのカバレッジレポート

### マイルストーン3: E2Eテスト追加・検証

**目標**: 主要導線のE2Eテストを整備する

| タスク | 説明 | Done条件 |
|--------|------|---------|
| 既存E2Eテスト確認 | CRUD、フィルタ、永続化、a11y、パフォーマンスのテストを確認 | 全テストがPASSする |
| 証跡取得確認 | スクリーンショット・動画が取得されることを確認 | `test-results/` に証跡が存在する |
| フレーク対策確認 | 安定セレクタ、waitFor使用を確認 | テストが安定して成功する |

**証跡**:
- `npm run test:e2e` の成功ログ
- `test-results/` 内のスクリーンショット（主要導線ごと）
- `test-results/` 内の動画（正常系・異常系）
- Playwright HTMLレポート

### マイルストーン4: 全品質ゲート検証

**目標**: 全品質ゲートを一括実行して成功を確認する

| タスク | 説明 | Done条件 |
|--------|------|---------|
| 全チェック実行 | `npm run check-all` を実行 | 終了コード0で完了 |
| 実行時間計測 | 全体の実行時間を計測 | 5分以内に完了 |
| 既存機能確認 | 001-personal-todoの機能が維持されていることを確認 | 全E2EテストがPASS |

**証跡**:
- `npm run check-all` の成功ログ
- 実行時間の記録
- Playwright HTMLレポート（全シナリオPASS）

## 📝 7. 品質ゲート実行手順

### 7.1 ローカル実行

開発者が日常的に実行する手順:

```bash
# 1. コード編集後にフォーマット適用
npm run format

# 2. リントチェック
npm run lint

# 3. 型チェック
npm run type-check

# 4. Unitテスト（watchモード - 開発中）
npm run test

# 5. コミット前に全チェック
npm run check-all
```

### 7.2 推奨ワークフロー

| タイミング | 実行者 | コマンド | 説明 |
|-----------|--------|---------|------|
| 保存時 | エディタ | Format on Save | 自動フォーマット |
| 開発中 | 開発者 | `npm run test` | Unitテストwatchモード |
| コミット前 | 開発者 | `npm run check-all` | 全品質ゲート実行 |
| プッシュ前 | 開発者 | `npm run test:e2e` | E2E最終確認 |
| CI（将来） | 自動 | `npm run check-all` | マージ前自動チェック |

### 7.3 証跡の取得タイミング

| 導線 | 取得タイミング | 証跡種類 |
|------|--------------|---------|
| タスク追加 | 追加完了後 | スクリーンショット、動画 |
| タスク完了 | 状態切替後 | スクリーンショット、動画 |
| タスク編集 | 編集保存後 | スクリーンショット、動画 |
| タスク削除 | 削除完了後 | スクリーンショット、動画 |
| フィルタ切替 | 各フィルタ表示後 | スクリーンショット、動画 |
| データ復元 | リロード後 | スクリーンショット、動画 |
| 失敗時 | テスト失敗時 | スクリーンショット、動画、トレース |

## ⚠️ 8. リスクと対策

| リスク | 影響度 | 発生確率 | 対策 |
|-------|--------|---------|------|
| テスト不安定（フレーク） | 中 | 中 | 安定セレクタ（data-testid）、waitFor使用、リトライ設定 |
| 実行時間増加 | 低 | 高 | 並列実行、Unitはwatch、E2Eは主要導線のみ |
| ツール競合（ESLint/Prettier） | 低 | 低 | eslint-config-prettierで競合回避 |
| スクリーンショット肥大化 | 低 | 中 | .gitignoreでtest-results/除外 |
| 動画ファイル肥大化 | 中 | 中 | 短いテストシナリオ設計、CI成果物で保持 |
| 開発者が実行しない | 中 | 中 | check-allコマンドで簡易化、将来CI強制 |
| 型エラー見落とし | 高 | 低 | type-checkをcheck-allに含める |
