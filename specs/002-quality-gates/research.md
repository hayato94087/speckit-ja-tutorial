# 🔬 リサーチ結果

| 項目 | 値 |
| --- | --- |
| **機能名** | 品質ゲート |
| **日付** | 2026-02-04 |
| **ステータス** | 完了 |

## 📑 目次

- [1. ツール選定](#-1-ツール選定)
  - [1.1 型チェック](#11-型チェック)
  - [1.2 リント](#12-リント)
  - [1.3 フォーマット](#13-フォーマット)
  - [1.4 Unitテスト](#14-unitテスト)
  - [1.5 E2Eテスト](#15-e2eテスト)
- [2. スクリプト設計](#-2-スクリプト設計)
  - [2.1 npm scripts一覧](#21-npm-scripts一覧)
  - [2.2 実行タイミング](#22-実行タイミング)
- [3. Unitテスト対象](#-3-unitテスト対象)
- [4. E2Eテスト対象](#-4-e2eテスト対象)
- [5. フレーク対策](#-5-フレーク対策)
- [6. 証跡取得](#-6-証跡取得)
- [7. リスクと対策](#-7-リスクと対策)

## 🔧 1. ツール選定

### 1.1 型チェック

| 項目 | 内容 |
|------|------|
| **ツール** | TypeScript (`tsc`) |
| **決定** | `tsc --noEmit` で型チェックのみ実行 |
| **根拠** | プロジェクトで既にTypeScript使用中。追加ツール不要 |
| **検討した代替案** | なし（TypeScriptが標準） |

### 1.2 リント

| 項目 | 内容 |
|------|------|
| **ツール** | ESLint |
| **決定** | eslint-config-next（core-web-vitals + typescript）を使用 |
| **根拠** | Next.js公式推奨設定。既に設定済み |
| **検討した代替案** | Biome - 高速だがNext.js統合が未成熟 |

### 1.3 フォーマット

| 項目 | 内容 |
|------|------|
| **ツール** | Prettier |
| **決定** | Prettierを追加し、ESLintとの競合を避ける設定 |
| **根拠** | 業界標準。エディタ統合が優れている。チーム開発で一貫性を担保 |
| **検討した代替案** | Biome - 高速だがエコシステムがPrettierより小さい |

### 1.4 Unitテスト

| 項目 | 内容 |
|------|------|
| **ツール** | Vitest |
| **決定** | 既存のVitest設定を継続使用 |
| **根拠** | Jestより高速。Vite互換。React Testing Library対応。既に設定済み |
| **検討した代替案** | Jest - 実績あるが設定が複雑でVitest比で低速 |

### 1.5 E2Eテスト

| 項目 | 内容 |
|------|------|
| **ツール** | Playwright |
| **決定** | 既存のPlaywright設定を拡張（スクリーンショット・動画追加） |
| **根拠** | Cypress比で高速。マルチブラウザ対応。トレース機能が優れている。既に設定済み |
| **検討した代替案** | Cypress - UIは優れるがPlaywrightより低速 |

## 🔧 2. スクリプト設計

### 2.1 npm scripts一覧

| スクリプト | コマンド | 用途 |
|-----------|---------|------|
| `type-check` | `tsc --noEmit` | 型チェック |
| `lint` | `eslint .` | リントチェック |
| `lint:fix` | `eslint . --fix` | リント自動修正 |
| `format` | `prettier --write .` | フォーマット適用 |
| `format:check` | `prettier --check .` | フォーマットチェック |
| `test` | `vitest` | Unitテスト（watchモード） |
| `test:run` | `vitest run` | Unitテスト（単発実行） |
| `test:e2e` | `playwright test` | E2Eテスト |
| `test:e2e:ui` | `playwright test --ui` | E2Eテスト（UIモード） |
| `check-all` | 全チェック一括実行 | コミット前の全検証 |

### 2.2 実行タイミング

| タイミング | 誰が | 何を実行 |
|-----------|------|---------|
| コード編集時 | 開発者 | `npm run lint`, `npm run type-check`（エディタ連携） |
| 保存時 | 開発者 | `npm run format`（エディタ連携） |
| 機能実装中 | 開発者 | `npm run test`（watchモード） |
| コミット前 | 開発者 | `npm run check-all` |
| プッシュ前 | 開発者 | `npm run test:e2e` |
| PR作成時 | CI（将来） | 全チェック自動実行 |

## 📋 3. Unitテスト対象

ロジック中心でUnitテストを実施する対象モジュール:

| モジュール | ファイル | テスト内容 |
|-----------|---------|----------|
| **バリデーション** | `src/lib/validation.ts` | 空文字、空白のみ、255文字超の検証 |
| **ストレージ** | `src/lib/storage.ts` | 保存、読み込み、空データ時の挙動 |
| **マイグレーション** | `src/lib/migration.ts` | データ形式変換、バージョン管理 |
| **タスクファクトリー** | `src/lib/task-factory.ts` | タスク生成、ID採番 |
| **フックロジック** | `src/hooks/use-todos.ts` | 追加、削除、編集、完了切替 |
| **フィルタロジック** | `src/hooks/use-filter.ts` | すべて/未完了/完了済みフィルタ |
| **ストレージフック** | `src/hooks/use-local-storage.ts` | localStorage連携 |

**既存テスト状況**:
- `tests/unit/lib/` - validation, storage, migration, task-factory
- `tests/unit/hooks/` - use-todos, use-local-storage

## 🎯 4. E2Eテスト対象

主要導線のシナリオをE2Eテストで実施:

| シナリオ | ファイル | テスト内容 |
|---------|---------|----------|
| **CRUD操作** | `todo-crud.spec.ts` | タスク追加（Enter/ボタン）、編集、削除、空文字ガード |
| **完了切替** | `todo-complete.spec.ts` | チェックボックス、未完了戻し、リロード後維持 |
| **フィルタ** | `todo-filter.spec.ts` | すべて/未完了/完了済み切替、件数表示 |
| **永続化** | `todo-persistence.spec.ts` | リロード後のデータ復元 |
| **アクセシビリティ** | `todo-a11y.spec.ts` | キーボード操作、フォーカス管理 |
| **パフォーマンス** | `todo-performance.spec.ts` | 大量タスク時の動作 |
| **レスポンシブ** | `todo-responsive.spec.ts` | 各画面サイズでの表示 |

**既存テスト状況**: 上記すべてのファイルが既に存在

## ⚠️ 5. フレーク対策

テストの安定性を確保するための方針:

### 5.1 安定セレクタ

| 方針 | 説明 |
|------|------|
| **data-testid使用** | `data-testid="todo-input"` など固定属性を使用 |
| **role属性活用** | `getByRole('button', { name: '追加' })` でアクセシビリティと両立 |
| **テキスト直接指定回避** | 国際化対応を考慮し、CSSクラスに依存しない |

### 5.2 待機戦略

| 方針 | 説明 |
|------|------|
| **`waitFor`使用** | 固定sleep禁止。状態変化を待機 |
| **`toBeVisible()`優先** | 要素の表示を確認してから操作 |
| **ネットワーク待機** | `waitForLoadState('networkidle')` でローディング完了を待機 |

### 5.3 分離

| 方針 | 説明 |
|------|------|
| **テスト間独立** | 各テストでlocalStorageをクリア |
| **並列実行対応** | `fullyParallel: true` でワーカー間分離 |
| **リトライ設定** | CI環境では `retries: 2` で一時的失敗に対応 |

## 📸 6. 証跡取得

動作確認の証跡を残すための設計:

### 6.1 スクリーンショット

| 設定 | 値 | 説明 |
|------|-----|------|
| **取得タイミング** | 常時 | 全テストでスクリーンショットを取得 |
| **保存場所** | `test-results/` | Playwright標準出力先 |
| **ファイル名** | テスト名ベース | `todo-crud-タスクの追加-chromium.png` |

Playwright設定:
```typescript
use: {
  screenshot: 'on',  // 常にスクリーンショット取得
}
```

### 6.2 動画

| 設定 | 値 | 説明 |
|------|-----|------|
| **取得タイミング** | 常時 | 正常系・異常系両方で動画保持 |
| **保存場所** | `test-results/` | Playwright標準出力先 |
| **フォーマット** | WebM | 軽量で再生互換性高い |

Playwright設定:
```typescript
use: {
  video: 'on',  // 常に動画取得
}
```

### 6.3 トレース

| 設定 | 値 | 説明 |
|------|-----|------|
| **取得タイミング** | 失敗時 | デバッグ用に詳細情報保持 |
| **保存場所** | `test-results/` | Playwright標準出力先 |

Playwright設定:
```typescript
use: {
  trace: 'retain-on-failure',  // 失敗時のみトレース保持
}
```

### 6.4 主要導線の証跡

| 導線 | 証跡タイミング |
|------|--------------|
| タスク追加 | 追加完了時点でスクリーンショット |
| タスク完了 | 状態切替後にスクリーンショット |
| フィルタ切替 | 各フィルタ表示時にスクリーンショット |
| データ復元 | リロード後にスクリーンショット |

## ⚠️ 7. リスクと対策

| リスク | 影響 | 対策 |
|-------|------|------|
| テスト不安定（フレーク） | 中 | 安定セレクタ、waitFor使用、リトライ設定 |
| 実行時間増加 | 低 | 並列実行、Unitはwatch、E2Eは主要導線のみ |
| ツール競合（ESLint/Prettier） | 低 | eslint-config-prettierで競合回避 |
| スクリーンショット肥大化 | 低 | .gitignoreでtest-results/除外、CI成果物で保持 |
| 動画ファイル肥大化 | 中 | 短いテストシナリオ設計、CI成果物で保持 |
| 開発者が実行しない | 中 | check-allコマンドで一括実行を簡易化 |
