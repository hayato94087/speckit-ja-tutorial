# 機能仕様

| 項目 | 内容 |
| --- | --- |
| **機能名** | 品質ゲート |
| **機能ブランチ** | `002-quality-gates` |
| **作成日** | 2026-02-04 |
| **ステータス** | 下書き |

## 📑 目次

- [1. 入力](#-1-入力)
- [2. ユーザーストーリー（必須）](#-2-ユーザーストーリー必須)
  - [2.1 US1: 型安全性の担保](#21-us1-型安全性の担保-p1)
  - [2.2 US2: コード品質の維持](#22-us2-コード品質の維持-p1)
  - [2.3 US3: ロジックの正確性検証](#23-us3-ロジックの正確性検証-p1)
  - [2.4 US4: 主要導線の動作検証](#24-us4-主要導線の動作検証-p1)
  - [2.5 US5: 既存機能の維持](#25-us5-既存機能の維持-p1)
  - [2.6 エッジケース](#26-エッジケース)
- [3. 要件（必須）](#-3-要件必須)
  - [3.1 機能要件](#31-機能要件)
  - [3.2 非機能要件](#32-非機能要件)
- [4. 成功基準（必須）](#-4-成功基準必須)
  - [4.1 測定可能な成果](#41-測定可能な成果)
- [5. 前提条件](#-5-前提条件)

## 📥 1. 入力

`/speckit.specify` コマンドの引数として提供された入力情報を以下に記載します。

```
品質ゲートを満たす仕様を追加してください。ツール名は固定せず、検証可能な受け入れ条件（AC）として書いてください。

目的（Why）:
- コードの品質を継続的に担保し、リグレッションを防止する
- チーム全員が一定の品質基準を満たすコードを書けるようにする

スコープ（What）:
品質ゲート（MUST）:
- 型チェックが通る
- リントが通る
- フォーマットチェックが通る
- Unitテストが通る（ロジック中心。どのモジュールをUnitで守るかも明記）
- E2Eテストが通る（主要導線のシナリオを列挙）

既存機能は維持:
- ToDoの追加/完了切替/編集/削除、フィルタ、端末内保存と復元

制約（Constraints）:
- 特定ツール名に依存せず、検証可能な受け入れ条件として記述

スコープ外（Out of Scope）:
- CI/CD パイプラインの構築
- コードカバレッジの閾値設定
- パフォーマンステストの自動化
```

## 👤 2. ユーザーストーリー（必須）

**ストーリーID凡例**:

| ID | 意味 | 説明 |
|----|------|------|
| `US1`, `US2`... | ユーザーストーリーID | tasks.mdの`[US1]`と対応。spec.mdの§2.xセクションに対応 |

**優先度凡例**:

| 優先度 | 意味 | 説明 |
|--------|------|------|
| P1 | 必須 | MVPに必須。これがないとリリースできない |
| P2 | 重要 | MVPに含めたい。時間が許せば実装 |
| P3 | あれば良い | 将来の拡張として検討。今回は実装しない可能性あり |

**憲章要件（必須）**:

- 各ユーザーストーリーに対して、どの粒度（Unit / Integration / E2E）で何を担保するかを明記する
- 品質ゲートは開発者が日常的に実行できるコマンドとして提供される

### 2.1 US1: 型安全性の担保 [P1]

**優先度**: P1

#### 説明

- 開発者がコードを変更した際に、型エラーがないことを検証できる
- 型チェックを実行し、すべてのファイルが型安全であることを確認する
- 型エラーがある場合は、エラー箇所と内容が明確に報告される

#### この優先度の理由

- 型安全性はランタイムエラーを未然に防ぐ最も基本的な品質ゲート
- 型エラーがあるコードはデプロイすべきではない

#### 独立テスト

- 型チェックコマンドを実行し、終了コードが0（成功）であることを確認
- 意図的に型エラーを含むコードを追加し、検出されることを確認

#### テスト粒度

- **Unit**: 該当なし（型チェック自体がツールの責務）
- **Integration**: 該当なし
- **E2E**: 該当なし（開発者が手動で実行）

#### 受入シナリオ

1. 型チェックが成功する
   - **Given**: プロジェクトのすべてのソースコードが存在する
   - **When**: 型チェックコマンドを実行する
   - **Then**: 終了コードが0（成功）となり、型エラーが報告されない

2. 型エラーが検出される
   - **Given**: 型エラーを含むコードが存在する
   - **When**: 型チェックコマンドを実行する
   - **Then**: 終了コードが0以外となり、エラー箇所とエラー内容が報告される

3. すべてのソースファイルが対象となる
   - **Given**: `src/` 配下にソースコードが存在する
   - **When**: 型チェックコマンドを実行する
   - **Then**: `src/` 配下のすべての対象ファイルが型チェックの対象となる

### 2.2 US2: コード品質の維持 [P1]

**優先度**: P1

#### 説明

- 開発者がコードを変更した際に、コーディング規約に違反していないことを検証できる
- リントチェックを実行し、すべてのファイルが規約に準拠していることを確認する
- フォーマットチェックを実行し、コードスタイルが統一されていることを確認する

#### この優先度の理由

- コーディング規約の統一はチーム開発の基盤
- 一貫性のないコードはレビュー負荷を増加させ、バグの温床となる

#### 独立テスト

- リントコマンドを実行し、終了コードが0（成功）であることを確認
- フォーマットチェックコマンドを実行し、終了コードが0（成功）であることを確認

#### テスト粒度

- **Unit**: 該当なし（リント/フォーマットチェック自体がツールの責務）
- **Integration**: 該当なし
- **E2E**: 該当なし（開発者が手動で実行）

#### 受入シナリオ

1. リントチェックが成功する
   - **Given**: プロジェクトのすべてのソースコードが存在する
   - **When**: リントコマンドを実行する
   - **Then**: 終了コードが0（成功）となり、違反が報告されない

2. リント違反が検出される
   - **Given**: コーディング規約に違反するコードが存在する
   - **When**: リントコマンドを実行する
   - **Then**: 終了コードが0以外となり、違反箇所と違反内容が報告される

3. フォーマットチェックが成功する
   - **Given**: プロジェクトのすべてのソースコードが存在する
   - **When**: フォーマットチェックコマンドを実行する
   - **Then**: 終了コードが0（成功）となり、フォーマット違反が報告されない

4. フォーマット違反が検出される
   - **Given**: フォーマット規約に違反するコードが存在する
   - **When**: フォーマットチェックコマンドを実行する
   - **Then**: 終了コードが0以外となり、違反ファイルが報告される

5. すべてのソースファイルが対象となる
   - **Given**: `src/` 配下にソースコードが存在する
   - **When**: リント/フォーマットコマンドを実行する
   - **Then**: `src/` 配下のすべての対象ファイルがチェック対象となる

### 2.3 US3: ロジックの正確性検証 [P1]

**優先度**: P1

#### 説明

- 開発者がロジックを変更した際に、既存の振る舞いが壊れていないことを検証できる
- Unitテストを実行し、すべてのテストが成功することを確認する
- テストが失敗した場合は、失敗したテストと原因が明確に報告される

#### この優先度の理由

- ロジックのリグレッションは最も見つけにくく、影響が大きいバグの原因
- Unitテストによる早期発見が修正コストを最小化する

#### 独立テスト

- Unitテストコマンドを実行し、終了コードが0（成功）であることを確認
- テスト対象モジュールが明確に定義されていることを確認

#### テスト粒度

- **Unit**: 以下のモジュールのロジックをUnitテストで守る
  - タスクの入力バリデーション（空文字、長さ制限）
  - タスクの完了フラグ切り替えロジック
  - タスクのフィルタリングロジック
  - ストレージの読み書きロジック
  - データマイグレーションロジック
- **Integration**: 該当なし（E2Eで担保）
- **E2E**: 該当なし（US4で担保）

#### 受入シナリオ

1. Unitテストが成功する
   - **Given**: テスト対象のモジュールとテストコードが存在する
   - **When**: Unitテストコマンドを実行する
   - **Then**: 終了コードが0（成功）となり、すべてのテストがPASSする

2. Unitテストが失敗する
   - **Given**: ロジックエラーを含むコードが存在する
   - **When**: Unitテストコマンドを実行する
   - **Then**: 終了コードが0以外となり、失敗したテストと期待値・実際値が報告される

3. タスク入力バリデーションがテストされる
   - **Given**: 入力バリデーションのUnitテストが存在する
   - **When**: Unitテストを実行する
   - **Then**: 空文字、空白のみ、255文字超のケースがテストされる

4. タスク完了切り替えロジックがテストされる
   - **Given**: 完了切り替えのUnitテストが存在する
   - **When**: Unitテストを実行する
   - **Then**: 未完了→完了、完了→未完了の状態遷移がテストされる

5. タスクフィルタリングがテストされる
   - **Given**: フィルタリングのUnitテストが存在する
   - **When**: Unitテストを実行する
   - **Then**: すべて/未完了/完了済みの各フィルタがテストされる

6. ストレージ読み書きがテストされる
   - **Given**: ストレージのUnitテストが存在する
   - **When**: Unitテストを実行する
   - **Then**: 保存、読み込み、空データ時の挙動がテストされる

### 2.4 US4: 主要導線の動作検証 [P1]

**優先度**: P1

#### 説明

- 開発者がUIを変更した際に、ユーザーの主要導線が壊れていないことを検証できる
- E2Eテストを実行し、すべてのシナリオが成功することを確認する
- テストが失敗した場合は、失敗したシナリオとスクリーンショットが報告される

#### この優先度の理由

- 主要導線の動作はユーザー体験に直結する
- E2Eテストにより、統合時の問題を早期発見できる

#### 独立テスト

- E2Eテストコマンドを実行し、終了コードが0（成功）であることを確認
- 失敗時にスクリーンショットまたはトレースが生成されることを確認

#### テスト粒度

- **Unit**: 該当なし（US3で担保）
- **Integration**: 該当なし
- **E2E**: 以下の主要導線シナリオをE2Eテストで守る
  - タスクの追加（入力→Enter/ボタン→一覧に表示）
  - タスクの完了切り替え（チェックボックス→視覚的変化）
  - タスクの編集（編集モード→保存→反映）
  - タスクの削除（削除ボタン→一覧から消える）
  - フィルタの切り替え（すべて/未完了/完了済み→一覧更新）
  - データの永続化（タスク追加→リロード→復元）

#### 受入シナリオ

1. E2Eテストが成功する
   - **Given**: E2Eテスト対象のアプリケーションとテストコードが存在する
   - **When**: E2Eテストコマンドを実行する
   - **Then**: 終了コードが0（成功）となり、すべてのシナリオがPASSする

2. E2Eテストが失敗する
   - **Given**: UIの動作に問題があるコードが存在する
   - **When**: E2Eテストコマンドを実行する
   - **Then**: 終了コードが0以外となり、失敗したシナリオとスクリーンショット/トレースが報告される

3. タスク追加シナリオがテストされる
   - **Given**: タスク追加のE2Eテストが存在する
   - **When**: E2Eテストを実行する
   - **Then**: Enterキーでの追加、追加ボタンでの追加、空文字が追加されないことがテストされる

4. タスク完了シナリオがテストされる
   - **Given**: タスク完了のE2Eテストが存在する
   - **When**: E2Eテストを実行する
   - **Then**: チェックボックスでの完了、未完了への戻し、リロード後の状態維持がテストされる

5. タスク編集シナリオがテストされる
   - **Given**: タスク編集のE2Eテストが存在する
   - **When**: E2Eテストを実行する
   - **Then**: 編集モードでの保存、Escapeでのキャンセルがテストされる

6. タスク削除シナリオがテストされる
   - **Given**: タスク削除のE2Eテストが存在する
   - **When**: E2Eテストを実行する
   - **Then**: 削除ボタンでの削除、一覧から消えることがテストされる

7. フィルタシナリオがテストされる
   - **Given**: フィルタのE2Eテストが存在する
   - **When**: E2Eテストを実行する
   - **Then**: すべて/未完了/完了済みの各フィルタで正しいタスクが表示されることがテストされる

8. データ永続化シナリオがテストされる
   - **Given**: データ永続化のE2Eテストが存在する
   - **When**: E2Eテストを実行する
   - **Then**: タスク追加後のリロードで復元されることがテストされる

### 2.5 US5: 既存機能の維持 [P1]

**優先度**: P1

#### 説明

- 品質ゲートを導入しても、既存の ToDo アプリ機能が正常に動作し続ける
- 既存の機能要件（001-personal-todo）がすべて満たされていることを確認する

#### この優先度の理由

- 品質ゲートの導入によって既存機能が壊れては本末転倒
- リグレッション防止が品質ゲートの主要目的

#### 独立テスト

- 001-personal-todo で定義されたすべての受入シナリオが引き続きPASSすることを確認

#### テスト粒度

- **Unit**: 001-personal-todo の Unit テスト対象モジュールすべて
- **Integration**: 該当なし
- **E2E**: 001-personal-todo の E2E テスト対象シナリオすべて

#### 受入シナリオ

1. タスクの追加機能が維持される
   - **Given**: ToDo アプリが起動している
   - **When**: タスクを追加する
   - **Then**: 001-personal-todo で定義された通りにタスクが追加される

2. タスクの完了切り替え機能が維持される
   - **Given**: タスクが一覧に存在する
   - **When**: 完了/未完了を切り替える
   - **Then**: 001-personal-todo で定義された通りに状態が切り替わる

3. タスクの編集機能が維持される
   - **Given**: タスクが一覧に存在する
   - **When**: タスクを編集する
   - **Then**: 001-personal-todo で定義された通りにタスク名が更新される

4. タスクの削除機能が維持される
   - **Given**: タスクが一覧に存在する
   - **When**: タスクを削除する
   - **Then**: 001-personal-todo で定義された通りにタスクが削除される

5. フィルタ機能が維持される
   - **Given**: 複数のタスクが存在する
   - **When**: フィルタを切り替える
   - **Then**: 001-personal-todo で定義された通りにフィルタリングされる

6. データ永続化機能が維持される
   - **Given**: タスクが保存されている
   - **When**: ページをリロードする
   - **Then**: 001-personal-todo で定義された通りにデータが復元される

### 2.6 エッジケース

- 型チェック、リント、フォーマットチェックが並行実行された場合、各結果が独立して報告される
- テスト実行中にファイルが変更された場合、テスト結果の信頼性が保証されない（再実行を推奨）
- 大量のエラーが検出された場合、出力が見やすく整理される（件数サマリーなど）
- 一部のテストがスキップされた場合、スキップ理由とともに報告される

## 📝 3. 要件（必須）

### 3.1 機能要件

- **FR-001**: システムは型チェックコマンドを提供し、すべてのソースファイルの型安全性を検証できなければならない
- **FR-002**: システムはリントコマンドを提供し、すべてのソースファイルのコーディング規約準拠を検証できなければならない
- **FR-003**: システムはフォーマットチェックコマンドを提供し、すべてのソースファイルのコードスタイル統一を検証できなければならない
- **FR-004**: システムはUnitテストコマンドを提供し、指定されたモジュールのロジック正確性を検証できなければならない
- **FR-005**: システムはE2Eテストコマンドを提供し、主要導線のシナリオ動作を検証できなければならない
- **FR-006**: 各コマンドは成功時に終了コード0、失敗時に0以外の終了コードを返さなければならない
- **FR-007**: 各コマンドは失敗時にエラー箇所とエラー内容を人間が理解できる形式で報告しなければならない

### 3.2 非機能要件

- **NFR-001**: 型チェック、リント、フォーマットチェックはそれぞれ個別実行時に1分以内に完了しなければならない（1,000ファイル未満の場合）
- **NFR-002**: Unitテストは個別実行時に2分以内に完了しなければならない（100テストケース未満の場合）
- **NFR-003**: E2Eテストは個別実行時に5分以内に完了しなければならない（主要導線シナリオのみの場合）
- **NFR-004**: コマンド出力は色分けされ、エラー/警告/成功が視覚的に区別できなければならない
- **NFR-005**: 型チェック、リント、フォーマットチェックは並列実行可能であり、`check-all` コマンドで並列実行して全体の実行時間を短縮しなければならない
- **NFR-006**: 全品質ゲート（check-all）はシリアル実行時に合計10分以内に完了しなければならない

## 🎯 4. 成功基準（必須）

### 4.1 測定可能な成果

1. **品質ゲート通過率**: すべての品質ゲート（型チェック、リント、フォーマット、Unit、E2E）が100%成功する
2. **開発者体験**: 品質ゲートの全コマンド実行が5分以内に完了する
3. **エラー検出精度**: 意図的に導入したエラー（型エラー、リント違反、テスト失敗）が100%検出される
4. **既存機能維持**: 001-personal-todo で定義されたすべての受入シナリオが引き続きPASSする
5. **ドキュメント完備**: 各品質ゲートの実行方法と期待結果が `specs/002-quality-gates/quickstart.md` に記載されている

## 📋 5. 前提条件

- プロジェクトに適切な型チェックツール（TypeScript等）が設定されている
- プロジェクトに適切なリンター（ESLint等）が設定されている
- プロジェクトに適切なフォーマッター（Prettier等）が設定されている
- プロジェクトに適切なテストランナー（Vitest, Jest等）が設定されている
- プロジェクトに適切なE2Eテストツール（Playwright, Cypress等）が設定されている
- 開発者はこれらのコマンドをローカル環境で実行できる
