# タスク

| 項目 | 内容 |
|------|------|
| **機能名** | 品質ゲート |
| **ブランチ** | `002-quality-gates` |
| **日付** | 2026-02-04 |
| **入力** | `/specs/002-quality-gates/` の設計ドキュメント |
| **前提条件** | plan.md、spec.md、research.md、data-model.md、quickstart.md |

## 📑 目次

- [1. フォーマット凡例](#-1-フォーマット凡例)
- [2. パス規約](#-2-パス規約)
- [3. Phase](#-3-phase)
- [4. 依存関係と実行順序](#-4-依存関係と実行順序)
- [5. 実装戦略](#-5-実装戦略)
- [6. 注意事項](#-6-注意事項)

**テスト**: この機能は品質ゲートの導入であり、テストコマンドの整備自体が目的です。既存のテストが正常に動作することを確認します。

**構成**: タスクはユーザーストーリーごとにグループ化され、各ストーリーの独立した実装とテストを可能にします。

## 📖 1. フォーマット凡例

**ストーリーID凡例**:

| ID | spec.md参照 | 説明 |
|----|-------------|------|
| `US1` | §2.1 | 型安全性の担保 |
| `US2` | §2.2 | コード品質の維持 |
| `US3` | §2.3 | ロジックの正確性検証 |
| `US4` | §2.4 | 主要導線の動作検証 |
| `US5` | §2.5 | 既存機能の維持 |

**優先度凡例**:

| 優先度 | 意味 | 説明 |
|--------|------|------|
| P1 | 必須 | MVPに必須。これがないとリリースできない |

**タスク記法**: `[ID] [P?] [Story] 説明`

| 記法 | 意味 | 説明 |
|------|------|------|
| `[P]` | 並列実行可能 | 異なるファイル、依存関係なし |
| `[US1]` `[US2]`... | ストーリーID | spec.md §2.x と対応するユーザーストーリー |
| `T001` `T002`... | タスクID | 連番でタスクを識別 |

## 📁 2. パス規約

| プロジェクトタイプ | ソースパス | テストパス |
|-------------------|-----------|-----------|
| 単一プロジェクト（Next.js App Router） | `src/` | `tests/` |

> パスはplan.mdの構造に基づいています

## 🚀 3. Phase

### Phase 1: セットアップ（共有インフラストラクチャ）

**目的**: Prettier導入とnpm scripts追加

- [ ] T001 `.prettierrc` にPrettier設定を作成
- [ ] T002 [P] `.prettierignore` にPrettier除外設定を作成
- [ ] T003 `package.json` にnpm scripts（type-check, format, format:check, check-all）を追加

### Phase 2: 基盤（ブロッキング前提条件）

**目的**: Playwright設定の拡張（スクリーンショット・動画・トレース）

**⚠️ 重要**: このフェーズが完了するまでユーザーストーリーの検証を開始できません

- [ ] T004 `playwright.config.ts` にスクリーンショット設定（screenshot: 'on'）を追加
- [ ] T005 [P] `playwright.config.ts` に動画設定（video: 'on'）を追加
- [ ] T006 [P] `playwright.config.ts` にトレース設定（trace: 'retain-on-failure'）を追加

> **✅ チェックポイント**: 基盤準備完了 - ユーザーストーリーの検証を開始可能

### Phase 3: US1 - 型安全性の担保 [P1]

**目標**: 型チェックコマンドが正常に動作し、型エラーを検出できることを確認

**独立テスト**: `npm run type-check` を実行し、終了コードが0であることを確認

#### US1の検証

- [ ] T007 [US1] `npm run type-check` を実行し、終了コード0（成功）を確認
- [ ] T008 [US1] すべての `src/` 配下のファイルが型チェック対象であることを確認
- [ ] T009 [US1] 意図的な型エラーを追加し、検出されることを確認（テスト後に削除）

> **✅ チェックポイント**: US1が完全に機能し、独立してテスト可能

### Phase 4: US2 - コード品質の維持 [P1]

**目標**: リントとフォーマットチェックコマンドが正常に動作することを確認

**独立テスト**: `npm run lint` と `npm run format:check` を実行し、終了コードが0であることを確認

#### US2の検証

- [ ] T010 [US2] `npm run lint` を実行し、終了コード0（成功）を確認
- [ ] T011 [P] [US2] `npm run format:check` を実行し、終了コード0（成功）を確認
- [ ] T012 [US2] すべての `src/` 配下のファイルがリント対象であることを確認
- [ ] T013 [P] [US2] フォーマット違反がある場合 `npm run format` で自動修正されることを確認

> **✅ チェックポイント**: US2が完全に機能し、独立してテスト可能

### Phase 5: US3 - ロジックの正確性検証 [P1]

**目標**: Unitテストが正常に実行され、すべてのテストがPASSすることを確認

**独立テスト**: `npm run test:run` を実行し、終了コードが0であることを確認

#### US3の検証

- [ ] T014 [US3] `npm run test:run` を実行し、すべてのUnitテストがPASSすることを確認
- [ ] T015 [P] [US3] `tests/unit/lib/validation.test.ts` でバリデーションロジックがテストされていることを確認
- [ ] T016 [P] [US3] `tests/unit/lib/storage.test.ts` でストレージロジックがテストされていることを確認
- [ ] T017 [P] [US3] `tests/unit/lib/migration.test.ts` でマイグレーションロジックがテストされていることを確認
- [ ] T018 [P] [US3] `tests/unit/lib/task-factory.test.ts` でタスクファクトリーロジックがテストされていることを確認
- [ ] T019a [P] [US3] `tests/unit/hooks/use-todos.test.ts` で完了切り替えロジック（未完了→完了、完了→未完了）がテストされていることを確認
- [ ] T019b [P] [US3] `tests/unit/hooks/use-local-storage.test.ts` でストレージフックがテストされていることを確認

> **✅ チェックポイント**: US3が完全に機能し、独立してテスト可能

### Phase 6: US4 - 主要導線の動作検証 [P1]

**目標**: E2Eテストが正常に実行され、すべてのシナリオがPASSし、証跡が取得されることを確認

**独立テスト**: `npm run test:e2e` を実行し、終了コードが0であることを確認

#### US4の検証

- [ ] T020 [US4] `npm run test:e2e` を実行し、すべてのE2EテストがPASSすることを確認
- [ ] T021 [P] [US4] `tests/e2e/todo-crud.spec.ts` でCRUD操作がテストされていることを確認
- [ ] T022 [P] [US4] `tests/e2e/todo-complete.spec.ts` で完了切り替えがテストされていることを確認
- [ ] T023 [P] [US4] `tests/e2e/todo-filter.spec.ts` でフィルタ操作がテストされていることを確認
- [ ] T024 [P] [US4] `tests/e2e/todo-persistence.spec.ts` で永続化がテストされていることを確認
- [ ] T025 [US4] `test-results/` にスクリーンショットが生成され、`npx playwright show-report` で確認できることを検証
- [ ] T026 [P] [US4] `test-results/` に動画ファイル（.webm）が生成されることを確認
- [ ] T027 [US4] 意図的にテストを失敗させ、`test-results/` にトレース（.zip）が保存されることを確認

> **✅ チェックポイント**: US4が完全に機能し、独立してテスト可能

### Phase 7: US5 - 既存機能の維持 [P1]

**目標**: US1-US4の品質ゲート導入により、001-personal-todoの機能が影響を受けていないことを最終確認

**独立テスト**: Phase 8の `npm run check-all` で一括確認

> **注記**: US4で個別シナリオを検証済み。このフェーズでは全体としてのリグレッションがないことを確認する。

#### US5の検証（US4完了後の最終確認）

- [ ] T028 [US5] すべてのE2Eテストが引き続きPASSすることを `npm run test:e2e` で最終確認
- [ ] T029 [US5] すべてのUnitテストが引き続きPASSすることを `npm run test:run` で最終確認

> **✅ チェックポイント**: 既存機能が維持されていることを確認

### Phase 8: 仕上げとクロスカッティング関心事

**目的**: 全品質ゲートの一括検証とドキュメント整備

- [ ] T034 `npm run check-all` を実行し、すべての品質ゲートが5分以内に成功することを確認
- [ ] T035 [P] 実行時間を計測し、NFR要件（型チェック1分、Unit2分、E2E5分）を満たすことを確認
- [ ] T036 [P] `npx playwright show-report` でHTMLレポートが表示されることを確認
- [ ] T037 quickstart.mdの手順に従って品質ゲートを実行し、手順が正確であることを確認

## 🔗 4. 依存関係と実行順序

### 4.1 フェーズの依存関係

| フェーズ | 依存先 | 説明 |
|---------|--------|------|
| Phase 1: セットアップ | なし | すぐに開始可能 |
| Phase 2: 基盤 | Phase 1 | Playwright設定拡張 |
| Phase 3: US1 | Phase 2 | 型チェック検証 |
| Phase 4: US2 | Phase 2 | リント・フォーマット検証 |
| Phase 5: US3 | Phase 2 | Unitテスト検証 |
| Phase 6: US4 | Phase 2 | E2Eテスト検証 |
| Phase 7: US5 | Phase 2 | 既存機能維持確認 |
| Phase 8: 仕上げ | 全US | すべてのユーザーストーリー完了後 |

### 4.2 ユーザーストーリーの依存関係

| ストーリー | 優先度 | 依存先 | 備考 |
|-----------|--------|--------|------|
| US1 | P1 | Phase 2 | 独立して実装可能 |
| US2 | P1 | Phase 2 | US1と並列実行可能 |
| US3 | P1 | Phase 2 | US1, US2と並列実行可能 |
| US4 | P1 | Phase 2 | US1, US2, US3と並列実行可能 |
| US5 | P1 | Phase 2 | 他のUSと並列実行可能 |

### 4.3 並列化の機会

```text
Phase 2完了後、以下を並列実行可能:

開発者A: US1（型チェック検証）
開発者B: US2（リント・フォーマット検証）
開発者C: US3（Unitテスト検証）
開発者D: US4（E2Eテスト検証）
開発者E: US5（既存機能維持確認）
```

## 🎯 5. 実装戦略

### 5.1 MVPファースト（Phase 1-2 + US1-US5）

この機能はすべてのユーザーストーリーがP1（必須）であるため、すべて実装が必要です。

1. Phase 1: セットアップを完了（Prettier導入、npm scripts追加）
2. Phase 2: 基盤を完了（Playwright設定拡張）
3. Phase 3-7: US1-US5を並列または順次で完了
4. Phase 8: 仕上げで全体検証

### 5.2 推奨実行順序

```text
1. npm run format        # フォーマット適用
2. npm run lint          # リント確認
3. npm run type-check    # 型チェック
4. npm run test:run      # Unitテスト
5. npm run test:e2e      # E2Eテスト
6. npm run check-all     # 全チェック一括実行
```

### 5.3 証跡の確認

```text
E2Eテスト後:
- test-results/ にスクリーンショットが保存される
- test-results/ に動画が保存される
- npx playwright show-report でHTMLレポートを表示
```

## 📌 6. 注意事項

### ⚙️ 記法ルール

- `[P]`タスク = 異なるファイル、依存関係なし
- `[USn]`ラベル = タスクをspec.mdのユーザーストーリーにマップ

### ⚠️ 必須ルール

- 各ユーザーストーリーは独立して完了可能でテスト可能である必要がある
- 各タスクまたは論理的なグループの後にコミット
- 任意のチェックポイントで停止してストーリーを独立して検証

### ❌ 避けること

- 曖昧なタスク
- 同じファイルの競合
- 独立性を壊すストーリー間の依存関係

### ✅ 成功基準

- すべての品質ゲート（型チェック、リント、フォーマット、Unit、E2E）が100%成功
- 品質ゲートの全コマンド実行が5分以内に完了
- 意図的に導入したエラーが100%検出される
- 001-personal-todoのすべての受入シナリオが引き続きPASS
